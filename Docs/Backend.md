# Backend Operations Documentation

## Architecture Overview

### Database: Supabase (PostgreSQL)
Sigma uses Supabase as the primary backend service, providing:
- PostgreSQL database with Row Level Security (RLS)
- Real-time subscriptions
- Built-in authentication
- Edge functions for serverless operations
- Auto-generated APIs

### Current Database Tables

#### 1. leads
**Purpose:** Store waitlist signups  
**RLS:** Enabled with public insert policy

```sql
CREATE TABLE leads (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text,
  created_at timestamptz DEFAULT timezone('utc'::text, now()) NOT NULL
);
```

**Policies:**
- `insert_lead`: Allows public users to insert leads

#### 2. profiles
**Purpose:** User profile management with Stripe integration  
**RLS:** Enabled with user-specific CRUD policies

```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  name text,
  email text,
  image text,
  customer_id text,      -- Stripe customer ID
  price_id text,         -- Stripe price ID
  has_access boolean DEFAULT false,
  created_at timestamptz DEFAULT (now() AT TIME ZONE 'UTC'::text),
  updated_at timestamptz DEFAULT (now() AT TIME ZONE 'UTC'::text)
);
```

**Policies:**
- `read_own_profile_data`: Users can read their own profile
- `insert_own_profile_data`: Users can insert their own profile
- `update_own_profile_data`: Users can update their own profile
- `delete_own_profile_data`: Users can delete their own profile

### Triggers and Functions

#### 1. update_updated_at()
**Purpose:** Automatically update the `updated_at` timestamp on profile changes

```sql
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

#### 2. handle_new_user()
**Purpose:** Automatically create profile when new user signs up

```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO profiles (id, email)
  VALUES (NEW.id, NEW.email);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### API Endpoints (Auto-generated by Supabase)

#### Authentication Endpoints
- `POST /auth/v1/signup` - User registration
- `POST /auth/v1/token` - User login
- `POST /auth/v1/logout` - User logout
- `POST /auth/v1/recover` - Password recovery

#### Database REST API
**Base URL:** `https://[project-id].supabase.co/rest/v1/`

##### Leads Management
```http
POST /leads
Content-Type: application/json
{
  "email": "user@example.com"
}
```

```http
GET /leads
Authorization: Bearer [service-role-key]
```

##### Profile Management
```http
GET /profiles?id=eq.[user-id]
Authorization: Bearer [user-token]
```

```http
PATCH /profiles?id=eq.[user-id]
Authorization: Bearer [user-token]
Content-Type: application/json
{
  "name": "John Doe",
  "has_access": true
}
```

### Environment Variables

#### Required Environment Variables
```env
# Supabase Configuration
VITE_SUPABASE_URL=https://[project-id].supabase.co
VITE_SUPABASE_ANON_KEY=[anon-key]
SUPABASE_SERVICE_ROLE_KEY=[service-role-key]

# Stripe Configuration (for future use)
STRIPE_SECRET_KEY=[stripe-secret-key]
STRIPE_WEBHOOK_SECRET=[webhook-secret]

# Email Service (for future use)
RESEND_API_KEY=[resend-api-key]
```

### Security Implementation

#### Row Level Security (RLS)
All tables have RLS enabled with specific policies:

1. **leads table**: Public insert only, admin read access
2. **profiles table**: User-specific access using `auth.uid()`

#### Authentication Flow
1. User signs up through Supabase Auth
2. `handle_new_user` trigger creates profile automatically
3. User receives confirmation email
4. Profile is accessible through authenticated API calls

### Planned Backend Operations

#### Phase 2: Enhanced User Management
- User onboarding flow
- Business profile creation wizard
- File upload for documents and branding assets
- Email verification and user activation

#### Phase 3: Business Automation Services
- Integration with legal document APIs
- Branding asset generation system
- Website builder API integration
- Payment processing setup automation

#### Phase 4: Advanced Features
- Real-time notifications
- Background job processing
- Multi-tenant architecture
- Advanced analytics and reporting

### Error Handling

#### Common Error Responses
```json
{
  "error": "Email already exists",
  "details": "duplicate key value violates unique constraint",
  "hint": "Please use a different email address",
  "code": "23505"
}
```

#### Error Types
- `400 Bad Request`: Invalid data format
- `401 Unauthorized`: Missing or invalid authentication
- `403 Forbidden`: RLS policy violation
- `409 Conflict`: Unique constraint violation
- `500 Internal Server Error`: Database or server issues

### Monitoring and Logging

#### Supabase Dashboard Metrics
- Database usage and performance
- API request volume and response times
- Authentication events and user activity
- Error rates and debugging information

#### Custom Logging (Planned)
- User interaction tracking
- Business automation job status
- Payment processing events
- Marketing campaign performance

### Backup and Recovery

#### Automatic Backups
- Supabase provides automated daily backups
- Point-in-time recovery available
- Data export capabilities through dashboard

#### Manual Backup Procedures
```sql
-- Export leads data
COPY (SELECT * FROM leads) TO '/tmp/leads_backup.csv' CSV HEADER;

-- Export profiles data
COPY (SELECT * FROM profiles) TO '/tmp/profiles_backup.csv' CSV HEADER;
```

### Performance Optimization

#### Database Indexing
```sql
-- Index for email lookups
CREATE INDEX idx_leads_email ON leads(email);
CREATE INDEX idx_profiles_email ON profiles(email);

-- Index for timestamp queries
CREATE INDEX idx_leads_created_at ON leads(created_at);
CREATE INDEX idx_profiles_updated_at ON profiles(updated_at);
```

#### Query Optimization
- Use specific column selection instead of SELECT *
- Implement pagination for large datasets
- Cache frequently accessed data
- Use database functions for complex operations

### Integration Points

#### External Services (Planned)
1. **Stripe**: Payment processing and subscription management
2. **Resend/SendGrid**: Email notifications and marketing
3. **Legal APIs**: Document generation and business registration
4. **Design APIs**: Logo and branding asset creation
5. **Website Builders**: Automated website deployment
6. **Marketing APIs**: Social media and advertising automation

---

*This document will be updated as new backend features are implemented and deployed.*